{% extends "layout.html" %}

{% load render_table from django_tables2 %}
{% load bootstrap4 %}
{% load static from staticfiles %}

{% block title_tag %}Dashboard{% endblock %}

{% block body_content %}
{% with request.user as user %}
<div class="container">
    <h1 class="my-5">Dashboard</h1>
    {% if groups_owned|length > 0 %}
    <div class="card mb-5">
        <h6 class="card-header">Your groups</h6>
        <div class="list-group list-group-flush">
            {% for group in groups_owned %}
            <a class="list-group-item list-group-item-action"
               href="{% url 'group-detail' group_id=group.group_id %}">
                <div class="d-flex align-items-center">
                    <span class="flex-grow-1">
                        <strong class="d-block">{{ group }}</strong>
                    </span>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    <div class="card mb-5">
        <h6 class="card-header">Your task sheets <a href="#" class="badge badge-secondary create-sheet">Add</a></h6>
        <div class="list-group list-group-flush">
            {% for sheet_data in sheets %}
            {% with task_sheet=sheet_data.sheet solved_count=sheet_data.solved_count %}
            <a class="list-group-item list-group-item-action"
               href="{% url 'sheet-detail' sheet_id=task_sheet.sheet_id %}">
                <div class="d-flex align-items-center">
                    <span class="flex-grow-1">
                        <strong class="mx-2">
                            {{ task_sheet.title }}
                        </strong>
                        {% if solved_count == task_sheet.tasks.all|length %}
                        <span class="badge badge-pill badge-success">
                        {% else %}
                        <span class="badge badge-pill badge-secondary">
                        {% endif %}
                            {{ solved_count }}/{{ task_sheet.tasks.all|length }} solved
                        </span>
                    </span>
                    <span class="small text-muted">
                        {{ task_sheet.created_at|date:"M d Y" }}
                    </span>
                    </span>
                </div>
            </a>
            {% endwith %}
            {% endfor %}
        </div>
        <div class="card-footer">
            <span class="small text-muted">
                {% if sheets|length <= 0 %}
                No task sheets.
                {% else %}
                {{ sheets|length }} task sheet{{ sheets|length|pluralize }}
                {% endif %}
            </span>
        </div>
    </div>
    <div class="card mb-5">
        <h6 class="card-header">Assigned to you</h6>
        <div class="list-group list-group-flush">
            {% for assignation_data in assignations %}
            {% with task_sheet=assignation_data.assignation.sheet solved_count=assignation_data.solved_count group=assignation_data.assignation.group %}
            <a class="list-group-item list-group-item-action"
               href="{% url 'sheet-results' group_id=group.group_id sheet_id=task_sheet.sheet_id %}">
                <div class="d-flex align-items-center">
                    <strong class="flex-grow-1 ml-2">
                        {{ task_sheet.title }}
                        {% if solved_count == task_sheet.tasks.all|length %}
                        <span class="badge badge-success">
                        {% else %}
                        <span class="badge badge-secondary">
                        {% endif %}
                            {{ solved_count }}/{{ task_sheet.tasks.all|length }} tasks solved
                        </span>
                    </strong>
                    <span class="small text-muted">
                        {{ task_sheet.created_at|date:"M d Y" }}
                    </span>
                    </span>
                </div>
                <span class="small d-block mt-1">In {{group}}</span>
            </a>
            {% endwith %}
            {% endfor %}
        </div>
        <div class="card-footer">
            <span class="small text-muted">
                {% if assignations|length <= 0 %}
                No task sheets.
                {% else %}
                {{ assignations|length }} task sheet{{ assignations|length|pluralize }}
                {% endif %}
            </span>
        </div>
    </div>
</div>
{% endwith %}
{% endblock %}


{% block js_scripts %}
<script type="text/javascript">
$(document).ready(function() {

    $(".create-sheet").modalForm({
        formURL: "{% url 'sheet-create' %}",
        errorClass: ".is-invalid",
    });

});
</script>
{% endblock %}