<div class="card mt-5" id="sheet-task-panel">
    <div class="card-header d-flex align-items-center">
        <h6 class="d-inline flex-grow-1 mb-0">Tasks</h6>
        {% if is_owner %}
        <a v-show="editMode" v-cloak class="badge badge-secondary mx-2"
           data-toggle="modal" href="#modal"
           onclick="loadModalForm('{% url 'sheet-task-add' sheet_id=sheet.sheet_id %}');">
            <i class="fa fa-plus mr-1"></i>Add
        </a>
        <a @click="toggleEditMode" href="#!" class="badge badge-dark badge-pill py-1">
            <span v-if="!editMode"><i class="fas fa-pen mr-1"></i>Edit</span>
        </a>
        <a @click="saveChanges" href="#!" class="badge badge-success badge-pill py-1" v-cloak>
            <span v-if="editMode">Done</span>
        </a>
        {% endif %}
    </div>
    {% if tasks %}
    <div class="list-group list-group-flush" id="taskList">
        {% for task_status in tasks %}
        {% with task=task_status.task verdict_for_user=task_status.verdict_for_user %}
        {% with idx=forloop.counter0 %}
        <a class="list-group-item list-group-item-action px-0 py-2"
           data-id="{{ idx }}"
           @mouseover="hoverIndex = {{ idx }}" @mouseout="hoverIndex = null"
           title="External: {{task.judge.judge_id}}/{{ task.task_id }}"
           href="{{ task.get_url }}" target="_blank" v-cloak>
            <div class="d-flex align-items-center">
                <span v-cloak v-show="editMode" class="pl-3 task-move">
                    <i class="fas fa-arrows-alt text-muted"></i>
                </span>
                <div class="py-1 px-3 border-right border-light">
                    {% include 'accounts/judge_label.html' with judge=task.judge %}
                    <span class="text-uppercase text-center text-monospace small font-weight-bold d-inline-block"
                          style="width: 2.5em">
                        {{ task.judge.judge_id }}
                    </span>
                </div>
                <span class="mx-3 text-primary flex-grow-1">
                    {{ task.name_or_id }}
                    <i v-show="hoverIndex === {{ idx }}" class="fas fa-xs fa-external-link-alt mx-2"></i>
                </span>
                <div class="mr-3">
                    <div v-cloak>
                        <div v-if="!editMode" class="d-inline">
                        {% if verdict_for_user %}
                            {% if verdict_for_user == 'AC' %}
                            <span class="text-success">
                                <i class="fas fa-check" style="width: 16px"></i>
                            </span>
                            {% else %}
                            <span class="text-danger">
                                <i class="fas fa-times" style="width: 16px"></i>
                            </span>
                            {% endif %}
                        {% endif %}
                        </div>
                        {% if is_owner %}
                        <form v-cloak v-show="editMode"
                              class="ml-3"
                              method="post" action="{% url 'sheet-task-delete' sheet_id=sheet.sheet_id %}">
                            {% csrf_token %}
                            <input type="hidden" value="{{ task.judge.judge_id }}" name="judge_id" />
                            <input type="hidden" value="{{ task.task_id }}" name="task_id" />
                            <button class="btn btn-danger btn-sm btn-xs-adjust align-middle my-0" type="submit">
                                <strong>Delete</strong>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </a>
        {% endwith %}
        {% endwith %}
        {% endfor %}
    </div>
    {% else %}
    <div class="card-body small text-muted">
        There are no tasks in this task sheet (yet).
        {% if is_owner %}
        <a data-toggle="modal" href="#modal"
           onclick="loadModalForm('{% url 'sheet-task-add' sheet_id=sheet.sheet_id %}');">
            Add a task
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
<script>
var sortable;

$('document').ready(function(){
    sortable = new Sortable(taskList, {
        animation: 150,
        handle: ".task-move",
    });
});

new Vue({
  delimiters: ["[[", "]]"],
  el: "#sheet-task-panel",
  data: {
    hoverIndex: null,
    editMode: false,
  },
  methods: {
    toggleEditMode: function() { this.editMode = !this.editMode; },
    saveChanges: function() {
        var ordering = sortable.toArray();
        $.post({
            url: "{% url 'sheet-task-reorder' sheet_id=sheet.sheet_id %}",
            data: {
                'csrfmiddlewaretoken': "{{ csrf_token }}",
                'ordering': JSON.stringify(ordering),
            },
        });
        this.toggleEditMode();
    },
  }
});
</script>